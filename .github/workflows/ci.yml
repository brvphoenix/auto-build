name: CI

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      os:
        description: 'Building on OS'
        required: true
        type: choice
        options:
        - windows
        - linux
        - all
      build:
        description: 'Building pkgs'
        required: true
        type: boolean
      type:
        description: 'Building type'
        required: true
        default: 'all'
        type: choice
        options:
        - dynamic
        - static
        - all
      arch:
        description: 'Architecture'
        required: true
        default: 'all'
        type: choice
        options:
        - aarch64
        - arm
        - x86
        - mips
        - all
      qt:
        description: 'QT version'
        required: true
        default: 'all'
        type: choice
        options:
        - 5
        - 6
        - all
      lt:
        description: 'libtorrent branch'
        required: true
        default: 'all'
        type: choice
        options:
        - 1.2
        - 2.0
        - all

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name }}-format("{0}-{1}-{2}-{3}-${4}", github.event.inputs.os, github.event.inputs.type, github.event.inputs.arch, github.event.inputs,qt, github.event.inputs.lt)
  cancel-in-progress: true

jobs:
  windows:
    if: github.event.inputs.os != 'linux'
    runs-on: windows-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    - name: Cache DL
      uses: actions/cache@v3
      with:
        path: D:\build\dl
        key: win-dl-${{ hashFiles(format('{0}\README.md', github.workspace)) }}
        restore-keys: win-dl-
    - shell: cmd
      working-directory: c:\
      run: |
        IF EXIST "D:\build\dl" (
            MKDIR "C:\build\dl"
            ROBOCOPY /MOVE /E /XX "D:\build\dl" "C:\build\dl"
        )
        CALL "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvarsall.bat" amd64
        MKDIR build
        COPY ${{ github.workspace }}\build.bat build
        CD build
        CALL build.bat
        CD ..
        MKDIR pack
        COPY build\stage\usr\bin\qbittorrent.* pack
        IF NOT EXIST "D:\build\dl" ( MKDIR "D:\build\dl" )
        ROBOCOPY /MOVE /E "C:\build\dl" "D:\build\dl"
        if %ERRORLEVEL% LEQ 7 set ERRORLEVEL=0
    - name: Upload build
      uses: actions/upload-artifact@v3
      with:
        name: windows_x64
        path: c:\pack
        if-no-files-found: error
  build-prep:
    if: github.event.inputs.os != 'windows'
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      draft: ${{ steps.create-draft.outcome }}
    steps:
    - name: Clone Current Repository
      uses: actions/checkout@v4
    - name: Install Dependencies
      run: |
        [ -n "$(command -v jq)" ] || {
        	sudo -E apt update
        	sudo -E apt -y install jq
        }
    - name: Format build matrix
      id: set-matrix
      run: |
        matrix='[]'
        for json_file in ./*.json; do
        	json_file_name=$(basename $json_file)
        	link=${json_file_name%.*}
        	[ -z "${{ github.event.inputs.type }}" ] || [ "${{ github.event.inputs.type }}" = "all" ] || [ "${{ github.event.inputs.type }}" = "${link}" ] || continue;
        	[ "$(jq -r '.openwrt.RUN_SKIP? // false' ${json_file})" = "false" ] || continue;
        	for arch in $(jq -r '.openwrt | to_entries[] | select((.value | type) == "object") | .key' ${json_file}); do
        		arch_wo_endian=${{ github.event.inputs.arch }}
        		arch_w_endian=$(echo $arch | cut -d '_' -f 1)
        		[ -z "${arch_wo_endian}" ] || [ "${arch_wo_endian}" = "all" ] || [ "${arch_wo_endian}" = "${arch_w_endian}" ] || [ "${arch_wo_endian}el" = "${arch_w_endian}" ] || [ "${arch_wo_endian}eb" = "${arch_w_endian}" ] || continue;
        		[ "$(jq -r '.openwrt."'$arch'".RUN_SKIP? // false' ${json_file})" = "false" ] || continue;
        		runtime_test=$(jq -r '.openwrt."'$arch'".RUNTIME_TEST? // false' ${json_file})
        		for libtorrent in $(jq -r '.qbittorrent.LIBTORRENT_VERSION? | to_entries[]? | .key?' ${json_file}); do
        			[ -z "${{ github.event.inputs.lt }}" ] || [ "${{ github.event.inputs.lt }}" = "all" ] || [ "${{ github.event.inputs.lt }}" = "${libtorrent/_/.}" ] || continue;
        			for qt in $(jq -r '.qbittorrent.QT_VERSION? | to_entries[]? | .key?' ${json_file}); do
        				[ -z "${{ github.event.inputs.qt }}" ] || [ "${{ github.event.inputs.qt }}" = "all" ] || [ "${{ github.event.inputs.qt }}" = "${qt}" ] || continue;
        				matrix="$(echo $matrix | jq -c '. += [{libtorrent:"'${libtorrent}'",qt:"'${qt}'",link:"'${link}'",arch:"'${arch}'",runtime_test:'${runtime_test}'}]')"
        			done
        		done
        	done
        done
        [ "${matrix}" != "[]" ] || exit 1
        echo "matrix={\"include\":${matrix}}" >> $GITHUB_OUTPUT
    - name: Create draft
      id: create-draft
      if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        [ "$(hub release --include-drafts | grep "${GITHUB_REF_NAME}" | wc -l)" -eq 0 ] || hub release delete "${GITHUB_REF_NAME}"
        hub release create -d -t master -m "Release ${GITHUB_REF_NAME}" "${GITHUB_REF_NAME}"
  build-matrix:
    name: ${{ matrix.link }}, ${{ matrix.arch }}, qt${{ matrix.qt }}, libtorrent_${{ matrix.libtorrent }}
    needs: build-prep
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.build-prep.outputs.matrix) }}
    steps:
    - name: Clone Current Repository
      uses: actions/checkout@v4
      with:
        path: auto-build
        persist-credentials: false
    - name: Install Dependencies
      env:
          run_test: ${{ matrix.runtime_test }}
      run: |
        sudo -E apt update
        sudo -E apt -y install build-essential curl flex gawk git jq libncurses5-dev \
        			libssl-dev python3 python3-distutils xz-utils zlib1g-dev
        [ "$run_test" = "true" ] || sudo -E apt install skopeo
    - name: Initializing
      working-directory: ./auto-build
      run: |
        bash ./init_env.sh "${{ matrix.arch }}" "${{ matrix.link }}" "${{ matrix.qt }}" "${{ matrix.libtorrent }}"
    - name: Cache SDK
      uses: actions/cache@v3
      id: cache-sdk
      with:
        path: ./${{ env.USE_SDK_FILE }}
        key: ${{ matrix.link }}-${{ matrix.arch }}-${{ env.USE_SDK_VERSION }}
    - if: steps.cache-sdk.outputs.cache-hit != 'true'
      run: curl -kLOZ --compressed "${USE_SOURCE_URL}/${USE_SDK_FILE}"
    - run: |
        [ "$(sha256sum ${USE_SDK_FILE} | cut -d ' ' -f1)" = "${USE_SDK_SHA256SUM}" ] || exit 1;
        mkdir -p build
        XZ_OPT='-T0' tar -xJf "${USE_SDK_FILE}" --strip-components=1 -C build
    - name: Cache feeds
      id: cache-feeds
      uses: actions/cache@v3
      with:
        path: |
          build/feeds/*
        key: feeds-${{ matrix.link }}-${{ env.USE_FEEDS_VERSION }}
        restore-keys: |
          feeds-${{ matrix.link }}-
          feeds-
    - name: Clone qbt
      uses: actions/checkout@v4
      with:
        ref: ${{ env.USE_QBT_REFS }}
        repository: ${{ github.repository_owner }}/SomePackages
        fetch-depth: 1
        token: ${{ secrets.SUPER_TOKEN }}
        path: qt_repo
    - name: Clone libt
      if: env.USE_LIBT_LOCAL != 'true'
      uses: actions/checkout@v4
      with:
        ref: ${{ env.USE_LIBT_REFS }}
        repository: ${{ github.repository_owner }}/SomePackages
        fetch-depth: 1
        token: ${{ secrets.SUPER_TOKEN }}
        path: libt_repo
    - name: Prepare required packages
      run: |
        bash ./auto-build/build_pre.sh "${{ matrix.qt }}" "${{ matrix.libtorrent }}" "${{ matrix.link }}"
    - name: Prepare building
      env:
        IGNORE_UPDATE_FEEDS: ${{ steps.cache-feeds.outputs.cache-hit }}
      working-directory: ./build
      run: |
        bash ../auto-build/build_conf.sh "${{ matrix.qt }}" "${{ matrix.link }}"
    - if: env.USE_LIBT_HASH == ''
      run: |
        echo USE_LIBT_HASH=$(sed -n 's/PKG_HASH:=\(\w\+\)/\1/gp' ./mirror/package/self/libtorrent-rasterbar/Makefile | head -c 10)" >> $GITHUB_ENV
    - run: |
        echo "USE_QT_VER=$(sed -n '/PKG_BASE:=/{N;s/PKG_BASE:=\([0-9.]\+\)\s\+PKG_BUGFIX:=\(\w\+\)/\1.\2/gp}' ./mirror/package/self/qtbase/Makefile)" >> $GITHUB_ENV
    - name: Cache downloaded source files (exclude Qt)
      uses: actions/cache@v3
      with:
        path: |
          build/dl/*
          !build/dl/qtbase-*.tar.xz
          !build/dl/qttools-*.tar.xz
        key: source-${{ matrix.link }}-${{ hashFiles(
             'build/package/self/**',
             '!build/package/self/libtorrent-rasterbar/**',
             '!build/package/self/qtbase/**',
             '!build/package/self/qttools/**',
             'build/feeds/base/package/libs/zlib/**',
             'build/feeds/packages/libs/boost/**',
             'build/feeds/base/package/libs/openssl/**',
             'build/feeds/packages/libs/pcre2/**'
             ) }}
        restore-keys: |
          source-${{ matrix.link }}-
          source-
    - name: Cache Qt source
      uses: actions/cache@v3
      with:
        path: |
          build/dl/qtbase-*-src-${{ env.USE_QT_VER }}.tar.xz
          build/dl/qttools-*-src-${{ env.USE_QT_VER }}.tar.xz
        key: qt-${{ env.USE_QT_VER }}
    - name: Cache binary
      if: needs.build-prep.outputs.draft == 'success' || github.event.inputs.build == 'true'
      id: cache-bin
      uses: actions/cache@v3
      with:
        path: |
          ${{ env.SAVED_NAME }}.tar.xz
          ${{ env.SAVED_NAME }}.log.tar.xz
        key: ${{ format('bin-{0}-{1}-{2}-{3}-{4}-{5}', env.USE_RELEASE_NUMBER, matrix.link, matrix.arch, env.USE_SDK_VERSION, env.USE_LIBT_HASH, 
             hashFiles(
             'build/package/self/**',
             'build/feeds/base/package/libs/zlib/**',
             'build/feeds/packages/libs/boost/**',
             'build/feeds/base/package/libs/openssl/**',
             'build/feeds/packages/libs/pcre2/**',
             'auto-build/build_conf.sh'
             )) }}
    - name: Build the Binary Files
      id: build-pkgs
      if: (needs.build-prep.outputs.draft == 'success' || github.event.inputs.build == 'true') && steps.cache-bin.outputs.cache-hit != 'true'
      working-directory: ./build
      run: |
        make defconfig
        make package/luci-app-qbittorrent/compile V=sc -j$(($(nproc)+1)) BUILD_LOG=1
    - name: Pack all the flies
      id: pack-all
      if: always()
      env:
        CACHE_HIT: ${{ steps.cache-bin.outputs.cache-hit }}
      run: |
        bash ./auto-build/pack_all.sh "${{ matrix.arch }}" "${{ matrix.link }}"
    - name: Upload Release Asset
      id: upload-release
      if: needs.build-prep.outputs.draft == 'success'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        [ -n "$(find ${SAVED_NAME} -type f -iname *qbittorrent*)" ] || exit 1
        cd auto-build
        hub release edit "${GITHUB_REF_NAME}" -a "../${SAVED_NAME}.tar.xz" -m ""
    - name: Upload the Pkgs
      if: always() && steps.upload-release.outcome != 'success' && steps.pack-all.outputs.pkgs == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.SAVED_NAME }}-pkgs-${{ steps.pack-all.outputs.hash }}
        path: ./${{ env.SAVED_NAME }}.tar.xz
        if-no-files-found: error
    - name: Upload the Logs
      if: always() && steps.pack-all.outputs.logs == 'true'
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.SAVED_NAME }}-log-${{ steps.pack-all.outputs.hash }}
        path: |
          ./${{ env.SAVED_NAME }}.log.tar.xz
        if-no-files-found: error
    - name: Cache busybox
      if: matrix.runtime_test && (steps.build-pkgs.outcome == 'success' || steps.cache-bin.outputs.cache-hit == 'true')
      id: cache-busybox
      uses: actions/cache@v3
      with:
        path: ~/docker_images/busybox.tar
        key: docker-busybox-${{ env.USE_BUSYBOX_HASH }}
    - if: steps.cache-busybox.outputs.cache-hit == 'true'
      run: |
        docker load -i ~/docker_images/busybox.tar
    - if: matrix.runtime_test && (steps.build-pkgs.outcome == 'success' || steps.cache-bin.outputs.cache-hit == 'true') && steps.cache-busybox.cache-hit != 'true'
      run: |
        docker pull busybox:latest
        mkdir -p ~/docker_images
        docker save -o ~/docker_images/busybox.tar busybox:latest
    - name: Cache qemu-user-static
      if: matrix.runtime_test && (steps.build-pkgs.outcome == 'success' || steps.cache-bin.outputs.cache-hit == 'true')
      id: cache-qus
      uses: actions/cache@v3
      with:
        path: ~/docker_images/qus.tar
        key: docker-qus-${{ env.USE_DOCKER_HASH }}
    - if: steps.cache-qus.outputs.cache-hit == 'true'
      run: |
        docker load -i ~/docker_images/qus.tar
    - if: matrix.runtime_test && (steps.build-pkgs.outcome == 'success' || steps.cache-bin.outputs.cache-hit == 'true') && steps.cache-qus.outputs.cache-hit != 'true'
      run: |
        docker pull multiarch/qemu-user-static:latest
        mkdir -p ~/docker_images
        docker save -o ~/docker_images/qus.tar multiarch/qemu-user-static:latest
    - name: Cache rootfs
      if: matrix.runtime_test && (steps.build-pkgs.outcome == 'success' || steps.cache-bin.outputs.cache-hit == 'true')
      id: cache-rootfs
      uses: actions/cache@v3
      with:
        path: ~/docker_images/openwrt_rootfs.tar
        key: docker-${{ env.RUN_ON_TARGET }}-${{ env.USE_OPENWRT_BRANCH }}-${{ env.USE_ROOTFS_HASH }}
    - if: steps.cache-rootfs.outputs.cache-hit == 'true'
      run: |
        docker load -i ~/docker_images/openwrt_rootfs.tar
    - if: matrix.runtime_test && (steps.build-pkgs.outcome == 'success' || steps.cache-bin.outputs.cache-hit == 'true') && steps.cache-rootfs.outputs.cache-hit != 'true'
      run: |
        docker pull openwrtorg/rootfs:${RUN_ON_TARGET}-${USE_OPENWRT_BRANCH}
        mkdir -p ~/docker_images
        docker save -o ~/docker_images/openwrt_rootfs.tar openwrtorg/rootfs:${RUN_ON_TARGET}-${USE_OPENWRT_BRANCH}
    - name: Build Docker container
      id: build-docker
      if: matrix.runtime_test && (steps.build-pkgs.outcome == 'success' || steps.cache-bin.outputs.cache-hit == 'true')
      run: |
        # register
        docker build -t qemu-static ./auto-build/docker/qemu
        docker run --rm --privileged qemu-static --reset -p yes
        # rootfs
        docker build -t test-container --build-arg ARCH="${RUN_ON_TARGET}" --build-arg BRANCH="${USE_OPENWRT_BRANCH}" ./auto-build/docker/rootfs
    - name: Test via Docker container
      if: steps.build-docker.outcome == 'success'
      run: |
        docker_host="127.0.0.1:28181"
        docker_id=$(docker run -d -p 127.0.0.1:28181:28181 --rm -v $GITHUB_WORKSPACE/${SAVED_NAME}:/ci test-container)
        end_time=$(($(date +%s) + 200))
        while [ "${end_time}" -gt "$(date +%s)" ]; do
        	if [ "$( docker container inspect -f '{{.State.Status}}' $docker_id )" = "running" ]; then
        		[ -f "/tmp/openwrt-${docker_id}.log" ] || docker logs "${docker_id}" -t -f &> /tmp/openwrt-${docker_id}.log &
        		if [ -n "$(docker exec $docker_id netstat -nl | grep 28181)" ]; then
        			sid=$(curl -is -m 10 \
        				-H "Referer: http://${docker_host}" \
        				-d 'username=admin&password=adminadmin' \
        				http://${docker_host}/api/v2/auth/login \
        				| grep '^set-cookie' | sed -n 's/\S\+ SID=\([^\x0-\x1f ",;\\\x7f]\+\); .*/\1/gp' 2>&1);
        			[ -z "$sid" ] || break;
        		fi

        		sleep 1
        	else
        		echo "::error ::The docker is not running!"
        		exit 1
        	fi
        done
        printf "Startup delay: %ss\n" $((200 + $(date +%s) - ${end_time}))

        if [ -n "$sid" ]; then
        	echo "::group::qBittorrent info"
        	echo "-------------------------------------------"
        	curl -s -m 10 --cookie "SID=${sid}" http://${docker_host}/api/v2/app/version | xargs echo "qBittorrent:"
        	curl -s -m 10 --cookie "SID=${sid}" http://${docker_host}/api/v2/app/webapiVersion | xargs echo "WebAPI:"
        	echo "-------------------------------------------"
        	curl -s -m 10 --cookie "SID=${sid}" http://${docker_host}/api/v2/app/buildInfo | jq -r 'to_entries[] | "\(.key): \(.value)"'
        	curl -s -m 10 -X POST --cookie "SID=${sid}" http://${docker_host}/api/v2/app/shutdown
        	echo "::endgroup::"
        	end_time=$(($(date +%s) + 100))
        	while [ "${end_time}" -gt "$(date +%s)" ]; do
        		shotId=$(echo $sid | cut -c 12)
        		[ -n "$(docker ps --format '{{.ID}}' | grep "${shortId}")" ] && sleep 1 || break;
        	done
        fi

        if [ -f "/tmp/openwrt-${docker_id}.log" ]; then
        	echo "::group::Docker logs"
        	cat /tmp/openwrt-${docker_id}.log
        	echo "::endgroup::"
        fi

        [ -n "$sid" ] || { echo "Can't connect to qbittorrent!!!"; exit 1; }
  pre-release:
    if: needs.build-prep.outputs.draft == 'success'
    needs: [build-prep, build-matrix]
    runs-on: ubuntu-latest
    steps:
    - name: Clone Current Repository
      uses: actions/checkout@v4
    - name: Edit Release Status
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        hub release edit "${GITHUB_REF_NAME}" -p --draft=false -m ""
